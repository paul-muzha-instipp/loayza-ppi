
{% extends "base_admin.html" %}
{% block contenido %}
<div class="container mt-3">
    <h1 class="text-center mb-3" style="color:#c40000;">Panel Administrativo</h1>
    <!-- Botones de navegación -->
    <div class="text-center mb-4">
        <a class="btn btn-primary mx-2 mb-2" href="{% url 'crear_usuario_admin' %}">Ingreso Usuario</a>
        <a class="btn btn-primary mx-2 mb-2" href="{% url 'admin_carrusel_gestion' %}">Administracion Pagina</a>
        <a class="btn btn-primary mx-2 mb-2" href="{% url 'admin_productos' %}">Productos</a>
        <a class="btn btn-primary mx-2 mb-2" href="{% url 'admin_categorias' %}">Categorías</a>
        <a class="btn btn-primary mx-2 mb-2" href="{% url 'admin_pedidos' %}">Pedidos</a>
        <a class="btn btn-primary mx-2 mb-2" href="{% url 'admin_clientes' %}">Clientes</a>
    </div>
    {% comment %} {% if cant_productos_bajo_stock > 0 %}
    <div class="alert alert-danger d-flex align-items-center mb-4 shadow-sm" role="alert" style="max-width:480px; margin:auto;">
        <i class="bi bi-exclamation-triangle-fill me-2 fs-4"></i>
        <div>
            Hay <b>{{ cant_productos_bajo_stock }}</b> producto{{ cant_productos_bajo_stock|pluralize }} con bajo stock.
            <a href="#" class="alert-link ms-2" data-bs-toggle="modal" data-bs-target="#stockBajoModal">
                Ver listado
            </a>
        </div>
    </div>
    {% endif %} {% endcomment %}

    <!-- KPIs -->
    <div class="row g-3 justify-content-center mb-2">
        <div class="col-lg-2 col-md-4 col-sm-6 mb-2">
            <div class="card shadow-sm text-center border-0 kpi-card">
                <div class="card-body p-3 kpi-body" >
                    <h6 class="text-muted mb-1">Ventas totales</h6>
                    <div class="fs-4 fw-bold text-success">${{ total_ventas|floatformat:2 }}</div>
                    <span class="kpi-badge d-block">&nbsp;</span>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-2">
            <div class="card shadow-sm text-center border-0 kpi-card">
                <div class="card-body p-3 kpi-body">
                    <h6 class="text-muted mb-1">Pedidos</h6>
                    <div class="fs-4 fw-bold text-primary">{{ total_pedidos }}</div>
                    <span class="kpi-badge d-block">&nbsp;</span>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-2">
            <div class="card shadow-sm text-center border-0 kpi-card">
                <div class="card-body p-3 kpi-body">
                    <h6 class="text-muted mb-1">Clientes</h6>
                    <div class="fs-4 fw-bold text-warning">{{ total_clientes }}</div>
                    <span class="kpi-badge d-block">&nbsp;</span>
                </div>
            </div>
        </div>
        <!-- KPIs - Stock total con alerta -->
        <div class="col-lg-2 col-md-4 col-sm-6 mb-2">
            <div class="card shadow-sm text-center border-0 position-relative kpi-card">
                <div class="card-body p-3 kpi-body">
                    <h6 class="text-muted mb-1">Stock total</h6>
                    <div class="fs-4 fw-bold text-secondary">{{ total_productos }}</div>
                    <span class="badge bg-danger mt-2" style="cursor:pointer;" data-bs-toggle="modal" data-bs-target="#stockBajoModal">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        {{ cant_productos_bajo_stock }} productos con bajo stock
                    </span>
                </div>
            </div>
        </div>

    </div>
    <!-- Gráficos principales -->
    <div class="row g-3 mb-3">
        <div class="col-md-6">
            <div class="card p-3 h-100">
                <h6 class="text-center">Ranking de Clientes</h6>
                <canvas id="rankingClientesChart" height="190"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card p-3 h-100">
                <h6 class="text-center">Pedidos por mes</h6>
                <canvas id="pedidosChart" height="190"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card p-3 h-100">
                <h6 class="text-center">Ventas por mes</h6>
                <canvas id="ventasChart" height="190"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card p-3 h-100">
                <h6 class="text-center">Nuevos clientes por mes</h6>
                <canvas id="clientesChart" height="190"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card p-3 h-100">
                <h6 class="text-center">Pedidos por estado</h6>
                <canvas id="pedidosEstadoChart" height="190"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card p-3 h-100">
                <h6 class="text-center">Top 5 productos más vendidos</h6>
                <canvas id="productosTopChart" height="190"></canvas>
            </div>
        </div>

    </div>
    <!-- Gráfico grande de predicción -->
    <div class="card my-4 p-4 shadow">
        <h5 class="text-center mb-2">Predicción de ventas próximos 3 meses</h5>
        <canvas id="prediccionChart" style="height: 300px;"></canvas>
    </div>
</div>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Gráfico 1: Pedidos por mes
    new Chart(document.getElementById('pedidosChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: {{ meses_labels|safe }},
            datasets: [{
                label: 'Pedidos',
                data: {{ pedidos_mes|safe }},
                backgroundColor: '#c40000'
            }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
    });

    // Gráfico 2: Ventas por mes
    new Chart(document.getElementById('ventasChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: {{ meses_labels|safe }},
            datasets: [{
                label: 'Ventas',
                data: {{ ventas_mes|safe }},
                fill: true,
                borderColor: '#228B22',
                backgroundColor: 'rgba(34,139,34,0.1)',
                tension: 0.25
            }]
        },
        options: { responsive: true }
    });

    // Gráfico 3: Clientes por mes
    new Chart(document.getElementById('clientesChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: {{ meses_labels|safe }},
            datasets: [{
                label: 'Nuevos clientes',
                data: {{ clientes_mes|safe }},
                fill: false,
                borderColor: '#007bff',
                tension: 0.15
            }]
        },
        options: { responsive: true }
    });
    
    // Gráfico: Pedidos por estado
    // Gráfico: Pedidos por estado
    // Ejemplo Chart.js para barras horizontales
    new Chart(document.getElementById('pedidosEstadoChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: {{ labels_pedidos_estado|safe }},
            datasets: [{
                label: 'Pedidos por estado',
                data: {{ data_pedidos_estado|safe }},
                backgroundColor: ['#ffc107', '#007bff', '#28a745', '#dc3545'],
                borderRadius: 8
            }]
        },
        options: {
            indexAxis: 'y', // Horizontal
            responsive: true,
            plugins: { legend: { display: false } }
        }
    });

    // (Coloca esto ANTES de new Chart(...))
    console.log("Meses:", {{ meses_labels|safe }}.concat({{ meses_futuro|safe }}));
    console.log("Ventas reales:", {{ ventas_mes|safe }});
    console.log("Predicción:", Array({{ ventas_mes|length }}).fill(null).concat({{ y_pred|safe }}));

    // Debug antes
    console.log("ventas_mes length:", {{ ventas_mes|safe }}.length);
    let nulls = Array({{ ventas_mes|length|stringformat:"d" }}).fill(null);
    console.log("nulls:", nulls.length, nulls);
    let pred = {{ ventas_mes|safe }}.concat({{ y_pred|safe }});

    console.log("pred data:", pred.length, pred);
    console.log("Predicción:", {{ y_pred|safe }});

    new Chart(document.getElementById('prediccionChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: {{ meses_labels|safe }}.concat({{ meses_futuro|safe }}),
            datasets: [
                {
                    label: 'Ventas reales',
                    data: {{ ventas_mes|safe }},
                    fill: false,
                    borderColor: '#c40000',
                    tension: 0.18
                },
                {
                    label: 'Predicción (simple)',
                    data: pred,
                    borderDash: [8, 4],
                    borderColor: '#ff9800',
                    fill: false,
                    tension: 0.2
                }
            ]
        },
        options: { responsive: true }
    });
    new Chart(document.getElementById('productosTopChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: {{ labels_productos_top|safe }},
            datasets: [{
                label: 'Unidades vendidas',
                data: {{ data_productos_top|safe }},
                backgroundColor: '#ff9800'
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            indexAxis: 'y', // para hacer horizontal; quita esta línea si lo prefieres vertical
            scales: {
                x: { beginAtZero: true }
            }
        }
    });


    new Chart(document.getElementById('rankingClientesChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: {{ labels_clientes_top|safe }},
            datasets: [{
                label: 'Compras totales ($)',
                data: {{ data_clientes_top|safe }},
                backgroundColor: '#228B22'
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } }
        }
    });

</script>
{% endblock %}